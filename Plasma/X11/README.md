# Центр программ Discover

**XCB** (X protocol C‑language Binding) — это библиотека на языке C, реализующая **клиентскую часть протокола X11** для графической системы **X Window System** (часто называемой просто «X»).

### Ключевые сведения

- **Назначение**: позволяет клиентским приложениям взаимодействовать с X‑сервером  (графическим сервером), отправляя запросы на отрисовку окон, обработку  ввода и т. д.
- **Язык реализации**: C.
- **Лицензия**: MIT (свободное ПО).
- **Дата первого выпуска**: 2001 год.
- **Текущая версия** (на апрель 2024): 1.17.0.
- **Разработчики**: Bart Massey, Jamey Sharp, Josh Triplett.
- **Репозиторий**: `gitlab.freedesktop.org/xorg/lib/libxcb`.
- **Официальный сайт**: `xcb.freedesktop.org`.

### Зачем нужен XCB

XCB создан как **более современная и компактная замена библиотеке Xlib**, которая долгое время была основным инструментом для работы с X Window System.

**Основные цели XCB:**

- уменьшить размер и сложность библиотеки;
- обеспечить прямой доступ к протоколу X11;
- сделать C‑интерфейс асинхронным (для лучшей поддержки многопоточности);
- упростить реализацию расширений (через XML‑описания протокола).

### Чем XCB отличается от Xlib

- **Меньший размер**: XCB исключает вспомогательные функции Xlib, которые редко  использовались приложениями. В результате скомпилированная библиотека  получается примерно в 30 раз меньше (по данным на 2004 год).
- **Асинхронность**: XCB позволяет отправлять запросы к серверу без ожидания ответа, что улучшает производительность в многопоточных приложениях.
- **Прямое работа с протоколом**: XCB предоставляет более низкий уровень абстракции, ближе к сырому протоколу X11, что даёт больше контроля разработчику.

### Как работает XCB (кратко)

1. Клиентское приложение создаёт соединение с X‑сервером через `xcb_connect()`.
2. Отправляет запросы на создание окон, рисование графики, обработку событий и т. д.
3. Получает события от сервера (нажатия клавиш, движения мыши, перерисовку окон) через цикл обработки событий.
4. Закрывает соединение через `xcb_disconnect()`.

### Пример минимального приложения на XCB

```c
#include <xcb/xcb.h>
#include <stdio.h>
#include <stdlib.h>

int main(void) {
    xcb_connection_t *c;
    xcb_screen_t *s;
    xcb_window_t w;
    xcb_gcontext_t g;
    xcb_generic_event_t *e;
    uint32_t mask;
    uint32_t values[2];
    int done = 0;

    // Подключение к X-серверу
    c = xcb_connect(NULL, NULL);
    if (xcb_connection_has_error(c)) {
        printf("Cannot open display\n");
        return 1;
    }

    // Получение первого экрана
    s = xcb_setup_roots_iterator(xcb_get_setup(c)).data;

    // Создание окна
    w = xcb_generate_id(c);
    mask = XCB_CW_BACK_PIXEL | XCB_CW_EVENT_MASK;
    values[0] = s->white_pixel;
    values[1] = XCB_EVENT_MASK_EXPOSURE | XCB_EVENT_MASK_KEY_PRESS;
    xcb_create_window(c, s->root_depth, w, s->root, 10, 10, 100, 100, 1,
                   XCB_WINDOW_CLASS_INPUT_OUTPUT, s->root_visual, mask, values);

    // Отображение окна
    xcb_map_window(c, w);
    xcb_flush(c);

    // Цикл обработки событий
    while (!done && (e = xcb_wait_for_event(c))) {
        switch (e->response_type & ~0x80) {
            case XCB_EXPOSE:
                // Перерисовка окна
                xcb_poly_fill_rectangle(c, w, g, 1, &r);
                xcb_flush(c);
                break;
            case XCB_KEY_PRESS:
                // Выход по нажатию клавиши
                done = 1;
                break;
        }
        free(e);
    }

    // Закрытие соединения
    xcb_disconnect(c);
    return 0;
}
```

### Когда использовать XCB

- Разработка низкоуровневых графических приложений под X Window System.
- Создание оконных менеджеров или композитных менеджеров.
- Приложения, требующие максимальной производительности и контроля над взаимодействием с X‑сервером.
- Замена устаревшего кода на Xlib (если нужна компактность и асинхронность).

### Ограничения

- XCB требует более глубокого понимания протокола X11, чем Xlib.
- Для простых приложений Xlib может быть удобнее из‑за более высокого уровня абстракции.
- XCB не заменяет полностью Xlib; некоторые утилиты и расширения могут по‑прежнему полагаться на Xlib.

### Связанные проекты

- **Xlib** — предыдущая основная библиотека для X Window System.
- **Wayland** — современная альтернатива X Window System, которая постепенно заменяет X в многих дистрибутивах Linux.
